---
title: "PANDA"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
    runtime: shiny
    source_code: embed
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r ,echo = FALSE, message = FALSE, warning = FALSE}
# Libraries
library(tidyverse)
library(readr)
library(kableExtra)
library(bookdown)
library(plotly)
library(scales)
library(flexdashboard)
drive <- read_csv(here::here("Data/practicaldrivingexaminationresults.csv"))
```

Introduction {data-icon="fa-car"}
==================================

Introduction about our analysis:

+ Data Description:

This data set is Practical driving examination results for customers which is provided by local government authority (LGA) of Queensland. It records the license class, booking type, examination results and driver age group during 2005 to 2019.

+ Research aims:

We divided into three parts, the first part focuses on the annual pass rate of different local government authority. 

The second part mainly aims to compare the age group with different license. 

The third part caculates the correlation between the examination results and booking type.

Age {data-icon="fa-car"}
==================================

Column {data-width=400}
-----------------------------------------------------------
### passrate
```{r}
### The whole pass rate of Queensland
wholerate <- drive %>%
  group_by(`Exam Result`) %>%
  count() %>%
  pivot_wider(id_cols = `Exam Result`,
              names_from = `Exam Result`,
              values_from = n) %>%
  mutate(passrate = PASS/(FAIL+PASS))

passrate = percent(wholerate$passrate)
valueBox(passrate,icon = "fa-user-plus",caption = "The driving examination pass rate of Queensland",color = "green")
```




### The pass rate of different licence
```{r}
#count the pass rate of each product type
type <- drive %>%
  group_by(`Product Type Name`, `Exam Result`) %>%
  count() %>%
  pivot_wider(id_cols = -`Exam Result`,
              names_from = `Exam Result`,
              values_from = n) %>%
  mutate(sum = FAIL + PASS,
         pass_rate = round(PASS /sum,2))%>%
  select(`Product Type Name`, pass_rate) %>%
  arrange(pass_rate) %>%
  mutate(pass_rate = percent(pass_rate))

kable(type)


```

Column {data-width=400}
-----------------------------------------------------------
### The fail rate of different ages
```{r}
fail <- drive %>%
 separate(col = Month,
          into = c("year",
                   "month"),
          "-") %>%
  mutate(year = as.numeric(year)) %>%
  filter(year %in% c("2005" : "2019" ))%>%
  group_by(`Driver Age Group`, `Exam Result`) %>%
  count() %>%
  pivot_wider(id_cols = -`Exam Result`,
              names_from = `Exam Result`,
              values_from = n) %>%
  mutate(sum = FAIL + PASS,
         fail_rate = round(FAIL /sum * 100, 3)) %>%
  mutate(Age_group1 = str_remove(`Driver Age Group`, "Aged"),
         Age_group2 = str_remove(Age_group1, "years")) %>%
  rename(age_group = Age_group2) %>%
  select(age_group, fail_rate) 
```

```{r}
# plot the fail rate 
fail_rate <- ggplot(fail,
       aes(x = age_group,
           y = fail_rate,
           group = 1))+
  geom_line(color = "#8FBC94", size = 1)+
  geom_point(color = "#548687", size = 2)+
  ggtitle("Queensland driving test fail rates by age")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))

ggplotly(fail_rate)
```


License {data-icon="fa-id-badge"}
==================================
Row
---------------------------------------------------------

### Compare the pass and fail in different driver licence
```{r}
# select the age group
age <- drive %>%
  select(`Product Type Name`, `Driver Age Group`, `Exam Result`, `Number of Examinations`) %>%
  mutate(Age_group1 = str_remove(`Driver Age Group`, "Aged"),
         Age_group2 = str_remove(Age_group1, "years"),
         licence = str_remove(`Product Type Name`, "CLASS")) %>%
  rename(age_group = Age_group2) %>%
# count the pass rate by different product type
  group_by(licence, age_group, `Exam Result`) %>%
  count()
```

```{r}
# plot the age group by license
licence <- ggplot(age,
       aes(x = age_group,
           y = n,
           fill = `Exam Result`))+
  geom_bar(stat = "identity", position = "fill", width=2)+
  geom_hline(yintercept = 0.5, color = "black")+
  facet_wrap(~licence, scales = "free_x", nrow = 2)+
  scale_fill_manual(values=c("#6E7783", "#77AAAD"))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))
ggplotly(licence) 
```

License {data-icon="fa-id-badge"}
==================================
Row
---------------------------------------------------------

### Logistic Regression Model
```{r}
drivedum <- dummy_cols(drive, select_columns =  c('Booking Type', 'Exam Result', 'Product Type Name'),
                       remove_selected_columns = TRUE)
train <- drivedum[1:252813,]
test <- drivedum[252814:337084,]

logmodel <- glm(`Exam Result_PASS` ~`Booking Type_Private`, family=binomial(link='logit'),data=train)

summary(logmodel)
anova(logmodel, test="Chisq")
```

```{r accuracy}
fitted.results <- predict(logmodel,newdata=test,type='response')
fitted.results <- ifelse(fitted.results > 0.5,1,0)
misClasificError <- mean(fitted.results != test$`Exam Result_PASS`)
print(paste('Accuracy',1-misClasificError))
```
// end of logistic regression model testing

```{r frequency table}
table <- table(drive$`Booking Type`,drive$`Exam Result`)
addmargins(table)
tab.prop <-  prop.table(table, 1)
```
A quick look at the frequency table between *Booking Type* and *Exam Result* and we saw that the number of people who passed the exam is similar for both driving school and private.

```{r chisq.test}
chisq.test(drive$`Booking Type`,drive$`Exam Result`)
```
However, when we run a chi-square test, the p-value is 0.0121 so we have statistical evidence that there is a relationship between *Booking Type* and *Exam Result*.

```{r}
tab.df <- as.data.frame(tab.prop)#make frequency table into data frame
names(tab.df) <- c("Booking Type", "Result", "frequency")

ggplot(tab.df, 
       aes(x=`Booking Type`, y = frequency, fill=Result)) + 
        geom_col() +theme_minimal()
```
